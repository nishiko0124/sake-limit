<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sake Limit Ultimate</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px;
            box-sizing: border-box;
        }
        .container {
            background: #34495e;
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 420px;
            text-align: center;
        }
        h1 { margin: 0 0 1.5rem 0; font-size: 1.5rem; color: #f1c40f; letter-spacing: 1px;}
        
        /* ãƒ¡ãƒ¼ã‚¿ãƒ¼ */
        .meter-wrapper {
            background: #22303d;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 25px;
            border: 1px solid #46637f;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .meter-header {
            display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: #bdc3c7;
        }
        .meter-container {
            height: 35px; background-color: #58636d; border-radius: 20px; overflow: hidden; position: relative;
        }
        .meter-fill {
            height: 100%; width: 0%; background-color: #2ecc71;
            transition: width 0.4s, background-color 0.4s;
            display: flex; align-items: center; justify-content: flex-end;
            padding-right: 12px; font-weight: bold; font-size: 0.9rem; color: #fff;
        }
        .status-message {
            margin-top: 10px; font-weight: bold; font-size: 1.1rem; min-height: 1.5em;
        }

        /* ãƒœã‚¿ãƒ³é¡ */
        .section-title {
            text-align: left; font-size: 0.9rem; color: #95a5a6; margin: 15px 0 5px 5px;
        }
        .button-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;
        }
        .drink-btn {
            border: none; border-radius: 12px; padding: 15px 5px; font-size: 1rem; font-weight: bold;
            cursor: pointer; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .drink-btn:active { transform: translateY(4px); box-shadow: none; }
        .drink-btn small { font-size: 0.7rem; font-weight: normal; opacity: 0.9; margin-top: 3px; }

        .btn-light { background-color: #3498db; }
        .btn-strong { background-color: #e74c3c; }
        .btn-water { background-color: #00cec9; color: #2d3436; grid-column: span 2; }

        /* æˆ»ã™ãƒœã‚¿ãƒ³ */
        .btn-undo {
            background-color: #95a5a6; color: white; width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px;
            border-radius: 8px; border: none; font-weight: bold; cursor: pointer; display: none; /* æœ€åˆã¯éè¡¨ç¤º */
        }
        .btn-undo:active { transform: scale(0.98); }

        /* ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ */
        .btn-reset {
            background-color: #7f8c8d; color: white; width: 100%; padding: 15px; margin-top: 30px;
            border-radius: 10px; border: none; font-size: 0.9rem; cursor: pointer;
        }

        .water-alert {
            background: #e74c3c; color: white; padding: 10px; border-radius: 8px; font-weight: bold;
            margin-bottom: 15px; display: none; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .footer-control {
            background: #2c3e50; padding: 15px; border-radius: 15px; margin-top: 20px;
        }
        input[type=range] { width: 100%; margin: 10px 0; accent-color: #f1c40f;}
        .log-area {
            text-align: left; font-size: 0.8rem; color: #7f8c8d; margin-top: 5px; max-height: 120px; overflow-y: auto;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ» Sake Limit Ultimate</h1>

    <div id="water-alert" class="water-alert">âš ï¸ æ°´ã‚’é£²ã‚“ã§ã‹ã‚‰1æ™‚é–“çµŒéï¼<br>æ°´ã‚’é£²ã¿ã¾ã—ã‚‡ã†ï¼</div>

    <div class="meter-wrapper">
        <div class="meter-header">
            <span>ãƒªãƒŸãƒƒãƒˆã¾ã§</span>
            <span id="score-display">0 / 100</span>
        </div>
        <div class="meter-container">
            <div id="meter-fill" class="meter-fill">0%</div>
        </div>
        <div id="status-message" class="status-message">ã‚·ãƒ©ãƒ•</div>
    </div>

    <div class="section-title">ğŸº ã‚¬ãƒ–ã‚¬ãƒ–ç³» (æ™®é€š)</div>
    <div class="button-grid">
        <button class="drink-btn btn-light" onclick="addDrink(25, 'ãƒ“ãƒ¼ãƒ«ä¸­')">
            ãƒ“ãƒ¼ãƒ«/ã‚µãƒ¯ãƒ¼<small>ä¸­ã‚¸ãƒ§ãƒƒã‚­ (25pt)</small>
        </button>
        <button class="drink-btn btn-light" onclick="addDrink(50, 'ã‚¹ãƒˆãƒ­ãƒ³ã‚°')">
            ã‚¹ãƒˆãƒ­ãƒ³ã‚°ç³»<small>ãƒ­ãƒ³ã‚°ç¼¶ (50pt)</small>
        </button>
    </div>

    <div class="section-title">ğŸ¶ ã¡ã³ã¡ã³ç³» (å¼·ã„)</div>
    <div class="button-grid">
        <button class="drink-btn btn-strong" onclick="addDrink(25, 'æ—¥æœ¬é…’(ãŠçŒªå£)')">
            æ—¥æœ¬é…’<small>ãŠçŒªå£1æ¯ (25pt)</small>
        </button>
        <button class="drink-btn btn-strong" onclick="addDrink(100, 'æ—¥æœ¬é…’(1åˆ)')">
            æ—¥æœ¬é…’<small>ä¸€åˆå¾³åˆ© (100pt)</small>
        </button>
        <button class="drink-btn btn-strong" onclick="addDrink(70, 'ãƒ¯ã‚¤ãƒ³(ã‚°ãƒ©ã‚¹)')">
            ãƒ¯ã‚¤ãƒ³<small>ã‚°ãƒ©ã‚¹1æ¯ (70pt)</small>
        </button>
        <button class="drink-btn btn-strong" onclick="addDrink(30, 'ã‚·ãƒ§ãƒƒãƒˆ')">
            æ´‹é…’ã‚·ãƒ§ãƒƒãƒˆ<small>ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼ç­‰ (30pt)</small>
        </button>
    </div>

    <div class="section-title">ğŸ’§ å›å¾©</div>
    <div class="button-grid">
        <button class="drink-btn btn-water" onclick="addWater()">
            ãŠæ°´ã‚’é£²ã‚“ã  (å›å¾© -5pt)
        </button>
    </div>

    <div class="footer-control">
        <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
            <label>é£²ã¿å§‹ã‚ã‹ã‚‰</label>
            <span id="time-display">0 æ™‚é–“</span>
        </div>
        <input type="range" id="timeSlider" min="0" max="8" step="0.5" value="0" oninput="updateTime(this.value)">
        
        <button id="btn-undo" class="btn-undo" onclick="undoLast()">â†©ï¸ ç›´å‰ã®å…¥åŠ›ã‚’å–ã‚Šæ¶ˆã™</button>

        <div class="log-area" id="log-area">å±¥æ­´: ãªã—</div>
    </div>

    <button class="btn-reset" onclick="resetData()">ğŸ”„ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
    let totalDrinkScore = 0;
    let waterScore = 0;
    let timeScore = 0;
    let lastWaterTime = Date.now();
    let drinkLogs = [];
    let actionHistory = []; // æ“ä½œå±¥æ­´ï¼ˆUndoç”¨ï¼‰
    const MAX_LIMIT = 100;

    window.onload = function() { loadData(); };

    // æ°´ã‚¢ãƒ©ãƒ¼ãƒˆç›£è¦–
    setInterval(() => {
        if (totalDrinkScore === 0) return;
        const now = Date.now();
        const diffMinutes = (now - lastWaterTime) / 1000 / 60;
        const alertBox = document.getElementById('water-alert');
        if (diffMinutes > 60) {
            alertBox.style.display = 'block';
        }
    }, 10000);

    function updateDisplay() {
        let currentScore = totalDrinkScore - waterScore - timeScore;
        if (currentScore < 0) currentScore = 0;

        const percentage = Math.min(currentScore, 100);
        const meter = document.getElementById('meter-fill');
        const status = document.getElementById('status-message');
        const scoreDisplay = document.getElementById('score-display');
        const undoBtn = document.getElementById('btn-undo');
        
        meter.style.width = percentage + '%';
        meter.innerText = Math.floor(percentage) > 10 ? Math.floor(percentage) + '%' : ''; 
        scoreDisplay.innerText = Math.floor(currentScore) + ' / ' + MAX_LIMIT;

        // Undoãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
        undoBtn.style.display = actionHistory.length > 0 ? 'block' : 'none';

        if (currentScore >= 100) {
            meter.style.backgroundColor = '#e74c3c';
            status.innerText = "ğŸš¨ é™ç•Œçªç ´ï¼çµ‚äº†ï¼";
            status.style.color = '#e74c3c';
        } else if (currentScore >= 80) {
            meter.style.backgroundColor = '#e67e22';
            status.innerText = "âš ï¸ ã‚‚ã†ã‚„ã°ã„ã€‚æ°´é£²ã‚“ã§ï¼";
            status.style.color = '#e67e22';
        } else if (currentScore >= 50) {
            meter.style.backgroundColor = '#f1c40f';
            status.innerText = "ğŸ¥´ ã»ã‚é…”ã„ã€‚ãƒšãƒ¼ã‚¹è½ã¨ã—ã¦";
            status.style.color = '#f1c40f';
        } else {
            meter.style.backgroundColor = '#2ecc71';
            status.innerText = "ğŸ˜Š ã¾ã ä½™è£•ã‚ã‚Š";
            status.style.color = '#2ecc71';
        }
    }

    function addDrink(points, name) {
        totalDrinkScore += points;
        addLog("ğŸº " + name + " (+" + points + ")");
        
        // å±¥æ­´ã«è¿½åŠ 
        actionHistory.push({ type: 'drink', val: points });
        
        updateDisplay();
        saveData();
        if (navigator.vibrate) navigator.vibrate(50);
    }

    function addWater() {
        waterScore += 5;
        lastWaterTime = Date.now();
        document.getElementById('water-alert').style.display = 'none';
        addLog("ğŸ’§ ãŠæ°´ (-5)");
        
        // å±¥æ­´ã«è¿½åŠ 
        actionHistory.push({ type: 'water', val: 5 });

        updateDisplay();
        saveData();
        if (navigator.vibrate) navigator.vibrate(30);
    }

    // --- Undo æ©Ÿèƒ½ ---
    function undoLast() {
        if (actionHistory.length === 0) return;

        const lastAction = actionHistory.pop(); // æœ€å¾Œã®æ“ä½œã‚’å–ã‚Šå‡ºã™

        if (lastAction.type === 'drink') {
            totalDrinkScore -= lastAction.val;
        } else if (lastAction.type === 'water') {
            waterScore -= lastAction.val;
            // æ°´ã®æ™‚é–“ã¯æˆ»ã›ãªã„ã®ã§ãã®ã¾ã¾ï¼ˆå†é€šçŸ¥ãŒæ—©ã¾ã‚‹ã ã‘ãªã®ã§å®‰å…¨å´ï¼‰
        }

        // ãƒ­ã‚°ã®å…ˆé ­ã‚’å‰Šé™¤
        drinkLogs.shift();
        renderLogs();

        updateDisplay();
        saveData();
        alert("ç›´å‰ã®å…¥åŠ›ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ");
    }

    function updateTime(val) {
        document.getElementById('time-display').innerText = val + " æ™‚é–“";
        timeScore = val * 15;
        updateDisplay();
        saveData();
    }

    function addLog(msg) {
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const logEntry = `<div><span style="color:#95a5a6">${time}</span> ${msg}</div>`;
        drinkLogs.unshift(logEntry);
        renderLogs();
    }

    function renderLogs() {
        const logArea = document.getElementById('log-area');
        logArea.innerHTML = drinkLogs.length === 0 ? "å±¥æ­´: ãªã—" : drinkLogs.join('');
    }

    function saveData() {
        const data = {
            total: totalDrinkScore,
            water: waterScore,
            timeVal: document.getElementById('timeSlider').value,
            lastWater: lastWaterTime,
            logs: drinkLogs,
            history: actionHistory // å±¥æ­´ã‚‚ä¿å­˜
        };
        localStorage.setItem('sakeLimitData', JSON.stringify(data));
    }

    function loadData() {
        const saved = localStorage.getItem('sakeLimitData');
        if (saved) {
            const data = JSON.parse(saved);
            totalDrinkScore = data.total || 0;
            waterScore = data.water || 0;
            lastWaterTime = data.lastWater || Date.now();
            drinkLogs = data.logs || [];
            actionHistory = data.history || []; // å±¥æ­´å¾©å…ƒ
            
            const slider = document.getElementById('timeSlider');
            slider.value = data.timeVal || 0;
            timeScore = slider.value * 15;
            document.getElementById('time-display').innerText = slider.value + " æ™‚é–“";

            renderLogs();
            updateDisplay();
        }
    }

    function resetData() {
        if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€æ–°ã—ã„é£²ã¿ä¼šã‚’å§‹ã‚ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem('sakeLimitData');
            totalDrinkScore = 0;
            waterScore = 0;
            timeScore = 0;
            drinkLogs = [];
            actionHistory = [];
            document.getElementById('timeSlider').value = 0;
            document.getElementById('time-display').innerText = "0 æ™‚é–“";
            lastWaterTime = Date.now();
            
            renderLogs();
            updateDisplay();
        }
    }
</script>

</body>
</html>
